"""
Test suite for Malware Detection
"""

import pytest
import numpy as np
import sys
import os

sys.path.insert(0, os.path.join(os.path.dirname(__file__), '..'))

try:
    from src.malware_detection import (
        ByteSequenceAnalyzer,
        OpCodeAnalyzer,
        PolymorphicDetector,
        MetamorphicDetector
    )
    CYTHON_AVAILABLE = True
except ImportError:
    CYTHON_AVAILABLE = False
    pytestmark = pytest.mark.skip("Cython modules not compiled")


@pytest.mark.skipif(not CYTHON_AVAILABLE, reason="Cython modules not available")
class TestByteSequenceAnalyzer:
    """Test ByteSequenceAnalyzer"""

    def test_initialization(self):
        """Test analyzer initialization"""
        analyzer = ByteSequenceAnalyzer()
        assert analyzer is not None

    def test_analyze_clean_data(self):
        """Test analysis of clean data"""
        analyzer = ByteSequenceAnalyzer()
        data = b'Hello, World!' * 100
        features = analyzer.analyze_bytes(data)
        assert len(features) > 0
        assert all(isinstance(f, (int, float, np.number)) for f in features)

    def test_analyze_random_data(self):
        """Test analysis of random (potentially malicious) data"""
        analyzer = ByteSequenceAnalyzer()
        data = bytes(np.random.randint(0, 256, 1000, dtype=np.uint8))
        features = analyzer.analyze_bytes(data)
        assert len(features) > 0


@pytest.mark.skipif(not CYTHON_AVAILABLE, reason="Cython modules not available")
class TestOpCodeAnalyzer:
    """Test OpCodeAnalyzer"""

    def test_initialization(self):
        """Test analyzer initialization"""
        analyzer = OpCodeAnalyzer()
        assert analyzer is not None

    def test_analyze_opcodes(self):
        """Test opcode analysis"""
        analyzer = OpCodeAnalyzer()
        # Simulate x86 opcodes
        data = bytes([0x90, 0xEB, 0x10, 0xCC, 0x50, 0x58] * 100)
        features = analyzer.analyze_opcodes(data)
        assert len(features) > 0


@pytest.mark.skipif(not CYTHON_AVAILABLE, reason="Cython modules not available")
class TestPolymorphicDetector:
    """Test PolymorphicDetector"""

    def test_initialization(self):
        """Test detector initialization"""
        detector = PolymorphicDetector()
        assert detector is not None

    def test_detect_clean_file(self):
        """Test detection on clean data"""
        detector = PolymorphicDetector()
        data = b'This is a clean text file.' * 100
        result = detector.detect(data)

        assert 'is_malicious' in result
        assert 'threat_level' in result
        assert 'polymorphism_score' in result
        assert isinstance(result['is_malicious'], bool)

    def test_detect_suspicious_data(self):
        """Test detection on suspicious data"""
        detector = PolymorphicDetector()
        # High entropy, random data
        data = bytes(np.random.randint(0, 256, 5000, dtype=np.uint8))
        result = detector.detect(data)

        assert 'polymorphism_score' in result
        assert 0.0 <= result['polymorphism_score'] <= 1.0

    def test_detect_executable_patterns(self):
        """Test detection of executable patterns"""
        detector = PolymorphicDetector()
        # PE header + some opcodes
        data = b'MZ\x90\x00' + bytes([0xEB, 0xE9, 0xCC] * 100)
        result = detector.detect(data)

        assert result['polymorphism_score'] >= 0.0


@pytest.mark.skipif(not CYTHON_AVAILABLE, reason="Cython modules not available")
class TestMetamorphicDetector:
    """Test MetamorphicDetector"""

    def test_initialization(self):
        """Test detector initialization"""
        detector = MetamorphicDetector()
        assert detector is not None

    def test_detect_metamorphic(self):
        """Test metamorphic detection"""
        detector = MetamorphicDetector()
        data = bytes([0xEB, 0x10, 0xE9, 0x20, 0xE8, 0x30] * 100)
        result = detector.detect_metamorphic(data)

        assert 'is_metamorphic' in result
        assert 'cfg_complexity' in result
        assert isinstance(result['is_metamorphic'], bool)


@pytest.mark.skipif(not CYTHON_AVAILABLE, reason="Cython modules not available")
def test_malware_detection_integration():
    """Integration test for malware detection"""
    poly_detector = PolymorphicDetector()
    meta_detector = MetamorphicDetector()

    # Test on various data types
    test_cases = [
        (b'Clean text data' * 100, 'TEXT'),
        (bytes(np.random.randint(0, 256, 1000)), 'RANDOM'),
        (b'MZ\x90\x00' + bytes([0xEB] * 500), 'EXECUTABLE'),
    ]

    for data, data_type in test_cases:
        poly_result = poly_detector.detect(data)
        meta_result = meta_detector.detect_metamorphic(data)

        assert poly_result is not None
        assert meta_result is not None
        assert 'is_malicious' in poly_result
        assert 'is_metamorphic' in meta_result


@pytest.mark.benchmark
@pytest.mark.skipif(not CYTHON_AVAILABLE, reason="Cython modules not available")
def test_detection_performance(benchmark):
    """Benchmark detection performance"""
    detector = PolymorphicDetector()
    data = bytes(np.random.randint(0, 256, 10000, dtype=np.uint8))

    result = benchmark(detector.detect, data)
    assert result is not None


if __name__ == '__main__':
    pytest.main([__file__, '-v'])
